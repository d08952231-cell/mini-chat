<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–ú–∏–Ω–∏-—á–∞—Ç —Å –≤–∏–¥–µ–æ</title>
<script src="https://cdn.jsdelivr.net/npm/peerjs@1.4.7/dist/peerjs.min.js"></script>
<style>
body{margin:0;font-family:sans-serif;position:relative;}
header{display:flex;justify-content:space-between;align-items:center;padding:10px;background:#0366d6;color:#fff;}
header h1{margin:0;font-size:18px;}
header button{padding:6px 10px;border:none;border-radius:4px;cursor:pointer;background:#fff;color:#0366d6;margin-left:6px;}
#chatScreen,#profileScreen{padding:16px;}
#chatScreen{display:block;}
#profileScreen{display:none;}
#messages{border:1px solid #ddd;padding:8px;height:300px;overflow-y:auto;margin-bottom:8px;border-radius:6px;}
.message{display:flex;gap:8px;margin:4px 0;padding:4px 6px;border-radius:4px;flex-direction:column;}
.message-content{display:flex;gap:8px;}
.message.me .text{background:#d1e7dd;}
.message.other .text{background:#f8d7da;}
.message .avatar{width:32px;height:32px;border-radius:50%;object-fit:cover;}
.message .text{padding:6px 10px;border-radius:6px;background:#eee;max-width:70%;}
.message.me .message-content{justify-content:flex-end;}
.message.other .message-content{justify-content:flex-start;}
.message .nickname{font-size:12px;color:#555;}
input[type="text"]{padding:8px;width:50%;margin-right:8px;border-radius:6px;border:1px solid #ccc;}
button.sendBtn,button.endBtn, #sendImageBtn, #callBtn{padding:8px 12px;border:none;border-radius:6px;cursor:pointer;margin-top:4px;}
button.sendBtn{background:#28a745;color:#fff;}
button.endBtn{background:#dc3545;color:#fff;margin-left:8px;}
#sendImageBtn{background:#ffc107;color:#000;margin-left:4px;}
#callBtn{background:#17a2b8;color:#fff;margin-left:4px;}
.avatar-container{display:flex;align-items:center;gap:16px;margin-bottom:16px;}
.avatar-container img{width:100px;height:100px;border-radius:50%;object-fit:cover;border:2px solid #ccc;}
input[type="file"]{display:none;}
label.uploadBtn{padding:6px 12px;background:#0366d6;color:#fff;border-radius:6px;cursor:pointer;}
#idContainer{margin-top:8px;font-size:14px;}
#howtoBtn{position:fixed;left:16px;bottom:16px;padding:10px 14px;background:#ffc107;color:#000;border:none;border-radius:6px;cursor:pointer;z-index:1000;}
#instructionModal{display:none;position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);background:#fff;padding:20px;border-radius:8px;box-shadow:0 0 10px rgba(0,0,0,0.5);max-width:300px;z-index:1001;}
#instructionModal h3{margin-top:0;}
#instructionModal button{margin-top:12px;background:#0366d6;color:#fff;padding:6px 10px;border:none;border-radius:6px;cursor:pointer;}
#videoContainer{margin-top:10px;display:flex;gap:8px;}
#videoContainer video{width:200px;border:1px solid #ccc;border-radius:6px;}
</style>
</head>
<body>

<header>
  <h1>–ú–∏–Ω–∏-—á–∞—Ç</h1>
  <div>
    <button id="profileBtn">–ü—Ä–æ—Ñ–∏–ª—å</button>
    <button id="closeProfileBtn" style="display:none;">‚úñ</button>
  </div>
</header>

<div id="chatScreen">
  <div>
    <input type="text" id="peerIdInput" placeholder="–í–≤–µ–¥–∏—Ç–µ ID —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞">
    <button id="connectBtn">–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è</button>
    <button id="endBtn" class="endBtn">–ó–∞–≤–µ—Ä—à–∏—Ç—å</button>
  </div>
  <div id="idContainer">
    –í–∞—à ID: <span id="myId">...</span> <button id="copyBtn" disabled>–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å ID</button>
  </div>
  <div id="messages"></div>
  <div>
    <input type="text" id="msgInput" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ">
    <button class="sendBtn" id="sendBtn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    <button id="sendImageBtn">+</button>
    <button id="callBtn">üìπ</button>
    <input type="file" id="imageInput" accept="image/*" style="display:none;">
  </div>
  <div id="videoContainer">
    <video id="localVideo" autoplay muted></video>
    <video id="remoteVideo" autoplay></video>
  </div>
</div>

<div id="profileScreen">
  <h2>–ü—Ä–æ—Ñ–∏–ª—å</h2>
  <div class="avatar-container">
    <img id="avatar" src="https://via.placeholder.com/100" alt="–ê–≤–∞—Ç–∞—Ä">
    <div>
      <label class="uploadBtn" for="avatarInput">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ</label>
      <input type="file" id="avatarInput" accept="image/*">
    </div>
  </div>
  <div>
    <label>–ù–∏–∫–Ω–µ–π–º:</label>
    <input type="text" id="nickname" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∏–∫–Ω–µ–π–º">
  </div>
  <button id="saveProfileBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</button>
</div>

<button id="howtoBtn">–ö–∞–∫ –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è?</button>
<div id="instructionModal">
  <h3>–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</h3>
  <ol>
    <li>–í–≤–µ–¥–∏—Ç–µ ID —Å–≤–æ–µ–≥–æ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞ –∏ –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É ¬´–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è¬ª.</li>
    <li>–û–∂–∏–¥–∞–π—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è. –ö–∞–∫ —Ç–æ–ª—å–∫–æ –≤—ã –ø–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å, –≤–∞–º –æ–± —ç—Ç–æ–º —Å–æ–æ–±—â–∞—Ç.</li>
    <li>–ß—Ç–æ–±—ã –∑–∞–≤–µ—Ä—à–∏—Ç—å —á–∞—Ç, –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É ¬´–ó–∞–≤–µ—Ä—à–∏—Ç—å¬ª.</li>
  </ol>
  <button id="closeInstruction">–ó–∞–∫—Ä—ã—Ç—å</button>
</div>

<script>
(async function(){
const profileBtn=document.getElementById('profileBtn');
const closeProfileBtn=document.getElementById('closeProfileBtn');
const chatScreen=document.getElementById('chatScreen');
const profileScreen=document.getElementById('profileScreen');
const avatarImg=document.getElementById('avatar');
const avatarInput=document.getElementById('avatarInput');
const nicknameInput=document.getElementById('nickname');
const saveProfileBtn=document.getElementById('saveProfileBtn');

const peerIdInput=document.getElementById('peerIdInput');
const connectBtn=document.getElementById('connectBtn');
const endBtn=document.getElementById('endBtn');
const msgInput=document.getElementById('msgInput');
const sendBtn=document.getElementById('sendBtn');
const sendImageBtn=document.getElementById('sendImageBtn');
const callBtn=document.getElementById('callBtn');
const imageInput=document.getElementById('imageInput');
const messagesDiv=document.getElementById('messages');

const myIdSpan=document.getElementById('myId');
const copyBtn=document.getElementById('copyBtn');

const localVideo=document.getElementById('localVideo');
const remoteVideo=document.getElementById('remoteVideo');

const howtoBtn=document.getElementById('howtoBtn');
const instructionModal=document.getElementById('instructionModal');
const closeInstruction=document.getElementById('closeInstruction');

let peer=new Peer();
let conn=null;
let localStream=null;
let currentCall=null;

// –ü—Ä–æ—Ñ–∏–ª—å
if(localStorage.getItem('avatar')) avatarImg.src=localStorage.getItem('avatar');
if(localStorage.getItem('nickname')) nicknameInput.value=localStorage.getItem('nickname');

profileBtn.onclick=()=>{chatScreen.style.display='none';profileScreen.style.display='block';profileBtn.style.display='none';closeProfileBtn.style.display='inline-block';};
closeProfileBtn.onclick=()=>{profileScreen.style.display='none';chatScreen.style.display='block';profileBtn.style.display='inline-block';closeProfileBtn.style.display='none';};

avatarInput.addEventListener('change',function(){const file=this.files[0];if(!file)return;const reader=new FileReader();reader.onload=function(e){avatarImg.src=e.target.result;};reader.readAsDataURL(file);});
saveProfileBtn.addEventListener('click',()=>{localStorage.setItem('avatar',avatarImg.src);localStorage.setItem('nickname',nicknameInput.value.trim());alert('–ü—Ä–æ—Ñ–∏–ª—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω!');});

copyBtn.onclick=()=>{const id=myIdSpan.textContent;if(!id||id==='...')return alert('ID –µ—â—ë –Ω–µ –≥–æ—Ç–æ–≤');navigator.clipboard.writeText(id).then(()=>{copyBtn.textContent='–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ';setTimeout(()=>copyBtn.textContent='–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å ID',1500);});};

peer.on('open',id=>{myIdSpan.textContent=id;copyBtn.disabled=false;});

connectBtn.onclick=()=>{const id=peerIdInput.value.trim();if(id){conn=peer.connect(id);setupConnection();}else alert('–í—ã –±—É–¥–µ—Ç–µ –∂–¥–∞—Ç—å –≤—Ö–æ–¥—è—â–µ–≥–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è...');};

endBtn.onclick=()=>{if(conn){conn.close();addMessage('–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ','other');conn=null;sendBtn.disabled=true;sendImageBtn.disabled=true;callBtn.disabled=true;}if(currentCall){currentCall.close();currentCall=null;remoteVideo.srcObject=null;localVideo.srcObject=null;}};

peer.on('connection',c=>{conn=c;setupConnection();});
function setupConnection(){if(!conn)return;conn.on('data',data=>{addMessage(data.text,'other',data.avatar,data.nickname,data.image);});conn.on('open',()=>{sendBtn.disabled=false;sendImageBtn.disabled=false;callBtn.disabled=false;addMessage('–í—ã –ø–æ–¥–∫–ª—é—á–∏–ª–∏—Å—å!','other');});conn.on('close',()=>{sendBtn.disabled=true;sendImageBtn.disabled=true;callBtn.disabled=true;});}

sendBtn.onclick=()=>{const text=msgInput.value.trim();if(!text||!conn||conn.open===false)return;const messageData={text,avatar:localStorage.getItem('avatar')||'https://via.placeholder.com/32',nickname:localStorage.getItem('nickname')||'–Ø'};conn.send(messageData);addMessage(messageData.text,'me',messageData.avatar,messageData.nickname);msgInput.value='';};

sendImageBtn.onclick=()=>imageInput.click();
imageInput.addEventListener('change',function(){const file=this.files[0];if(!file)return;const reader=new FileReader();reader.onload=function(e){const imageData=e.target.result;if(!conn||conn.open===false)return;const messageData={text:'',image:imageData,avatar:localStorage.getItem('avatar')||'https://via.placeholder.com/32',nickname:localStorage.getItem('nickname')||'–Ø'};conn.send(messageData);addMessage('', 'me', messageData.avatar, messageData.nickname, messageData.image);};reader.readAsDataURL(file);this.value='';});

// –ê–≤—Ç–æ-–∑–∞–ø—Ä–æ—Å –∫–∞–º–µ—Ä—ã
(async function initCamera(){try{localStream=await navigator.mediaDevices.getUserMedia({video:true,audio:true});localVideo.srcObject=localStream;}catch(e){alert('–î–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ –∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É –æ—Ç–∫–ª–æ–Ω—ë–Ω. –û—Ç–∫—Ä–æ–π—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É –Ω–∞ HTTPS –∏–ª–∏ localhost –∏ —Ä–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø.');console.error(e);}})();

callBtn.onclick=async()=>{try{if(!localStream)localStream=await navigator.mediaDevices.getUserMedia({video:true,audio:true});localVideo.srcObject=localStream;if(!conn||conn.open===false)return alert('–ù–µ—Ç —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞');const id=peerIdInput.value.trim();if(!id)return alert('–í–≤–µ–¥–∏—Ç–µ ID —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞');const call=peer.call(id,localStream);setupCall(call);}catch(e){alert('–î–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ –∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É –æ—Ç–∫–ª–æ–Ω—ë–Ω');console.error(e);}};

peer.on('call',async call=>{try{if(!localStream)localStream=await navigator.mediaDevices.getUserMedia({video:true,audio:true});localVideo.srcObject=localStream;call.answer(localStream);setupCall(call);}catch(e){alert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ –∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É');console.error(e);}});

function setupCall(call){if(currentCall)currentCall.close();currentCall=call;call.on('stream',stream=>{remoteVideo.srcObject=stream;});call.on('close',()=>{currentCall=null;remoteVideo.srcObject=null;addMessage('–í–∏–¥–µ–æ–∑–≤–æ–Ω–æ–∫ –∑–∞–≤–µ—Ä—à—ë–Ω','other');});}

function addMessage(msg,type,avatar,nickname,image){const div=document.createElement('div');div.className='message '+type;const nicknameEl=document.createElement('div');nicknameEl.className='nickname';nicknameEl.textContent='–û—Ç '+(nickname||'–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π');const contentDiv=document.createElement('div');contentDiv.className='message-content';const avatarEl=document.createElement('img');avatarEl.className='avatar';avatarEl.src=avatar||'https://via.placeholder.com/32';const textEl=document.createElement('div');textEl.className='text';if(msg)textEl.textContent=msg;if(type==='me'){if(image){const imgEl=document.createElement('img');imgEl.src=image;imgEl.style.maxWidth='200px';imgEl.style.borderRadius='6px';contentDiv.appendChild(imgEl);}contentDiv.appendChild(textEl);contentDiv.appendChild(avatarEl);}else{contentDiv.appendChild(avatarEl);if(image){const imgEl=document.createElement('img');imgEl.src=image;imgEl.style.maxWidth='200px';imgEl.style.borderRadius='6px';contentDiv.appendChild(imgEl);}contentDiv.appendChild(textEl);}div.appendChild(nicknameEl);div.appendChild(contentDiv);messagesDiv.appendChild(div);messagesDiv.scrollTop=messagesDiv.scrollHeight;}

sendBtn.disabled=true;sendImageBtn.disabled=true;callBtn.disabled=true;

howtoBtn.onclick=()=>{instructionModal.style.display='block';};
closeInstruction.onclick=()=>{instructionModal.style.display='none';};

})();
</script>
</body>
</html>